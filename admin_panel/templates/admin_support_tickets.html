<!--
Arquivo: admin_panel/templates/admin_support_tickets.html

Responsabilidade:
Listar e gerenciar tickets de suporte.

Integra√ß√µes:
- admin_panel/app.py
-->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tickets de Suporte - ISP ERP</title>

  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}" />
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-components.css') }}" />
</head>
<body>
  <!-- Skip Link -->
  <a href="#main-content" class="skip-link">Pular para o conte√∫do principal</a>

  <!-- Navigation -->
  {% include 'components/navbar.html' %}

  <!-- Main Content -->
  <main id="main-content" class="main-content">
    <div class="container">

      <!-- Breadcrumbs -->
      <nav aria-label="Breadcrumb" class="breadcrumb">
        <span class="breadcrumb-item">
          <a href="/">Home</a>
        </span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">
          <a href="/admin/support">Suporte</a>
        </span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">Tickets</span>
      </nav>

      <!-- Page Header -->
      <header class="page-header">
        <div class="page-header-content">
          <h1 class="page-title">Tickets de Suporte</h1>
          <p class="page-subtitle">Gerencie os atendimentos e ocorr√™ncias</p>
        </div>
        <div class="page-header-actions">
          <button type="button" class="btn btn-outline-primary" onclick="window.location.reload()">
            <span aria-hidden="true">üîÑ</span>
            Atualizar
          </button>
          <button type="button" class="btn btn-primary" data-modal-target="modal-ticket">
            <span aria-hidden="true">‚ûï</span>
            Novo Ticket
          </button>
        </div>
      </header>

      <!-- Filters -->
      <div id="filter-container"></div>

      <!-- Data Table -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Ocorr√™ncias Recentes</h2>
        </div>
        <div class="card-body">
          <div id="table-container"></div>
        </div>
      </div>

    </div>
  </main>

  <!-- Modal: New Ticket -->
  <div id="modal-ticket" class="modal-overlay" style="display: none;">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Novo Ticket</h2>
        <button class="modal-close" aria-label="Fechar modal" data-modal-close>‚úï</button>
      </div>
      <div class="modal-body">
        <form id="form-ticket" method="post" data-validate>
          
          <div class="form-row">
            <div class="form-group">
              <label for="client_id" class="form-label required">Cliente</label>
              <select id="client_id" name="client_id" class="form-control" required>
                <option value="">Selecione um cliente...</option>
                {% for client in clients %}
                <option value="{{ client.id }}">{{ client.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label for="category_id" class="form-label required">Categoria</label>
              <select id="category_id" name="category_id" class="form-control" required>
                <option value="">Selecione...</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="priority" class="form-label required">Prioridade</label>
              <select id="priority" name="priority" class="form-control" required>
                <option value="low">Baixa</option>
                <option value="normal" selected>Normal</option>
                <option value="high">Alta</option>
                <option value="critical">Cr√≠tica</option>
              </select>
            </div>
            <div class="form-group">
              <label for="assignee_id" class="form-label">Atribuir a</label>
              <select id="assignee_id" name="assignee_id" class="form-control">
                <option value="">Ningu√©m</option>
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.username }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="subject" class="form-label required">Assunto</label>
            <input type="text" id="subject" name="subject" class="form-control" required />
          </div>

          <div class="form-group">
            <label for="description" class="form-label required">Descri√ß√£o</label>
            <textarea id="description" name="description" class="form-control" rows="4" required></textarea>
          </div>
          
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-modal-close>Cancelar</button>
        <button type="submit" form="form-ticket" class="btn btn-primary">Criar Ticket</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  {% include 'components/footer.html' %}

  <!-- JavaScript -->
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script src="{{ url_for('static', filename='js/navbar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/footer.js') }}"></script>
  <script src="{{ url_for('static', filename='js/components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/advanced-components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {

      // Filter Panel
      const filterPanel = new ISP_Components.FilterPanel({
        container: '#filter-container',
        filters: [
          { type: 'text', name: 'protocol', label: 'Protocolo', placeholder: 'Busca por protocolo' },
          { type: 'select', name: 'status', label: 'Status', options: [
            { value: 'open', label: 'Aberto' },
            { value: 'in_progress', label: 'Em Progresso' },
            { value: 'closed', label: 'Fechado' }
          ]},
          { type: 'select', name: 'priority', label: 'Prioridade', options: [
            { value: 'normal', label: 'Normal' },
            { value: 'high', label: 'Alta' },
            { value: 'critical', label: 'Cr√≠tica' }
          ]}
        ],
        onApply: (filters) => {
          const params = new URLSearchParams(window.location.search);
          Object.keys(filters).forEach(key => {
             if(filters[key]) params.set(key, filters[key]);
             else params.delete(key);
          });
          window.location.search = params.toString();
        },
        onReset: () => {
          window.location.href = window.location.pathname;
        }
      });

      // Data
      const ticketsData = [
        {% for item in items %}
        {
          id: {{ item.id }},
          protocol: '{{ item.protocol }}',
          client: '{{ item.client.name | replace("'", "\\'") }}',
          category: '{{ item.category.name | replace("'", "\\'") }}',
          subject: '{{ item.subject | replace("'", "\\'") }}',
          status: '{{ item.status }}',
          priority: '{{ item.priority }}',
          created_at: '{{ item.created_at.strftime("%d/%m/%Y %H:%M") }}',
          assignee: '{{ (item.assignee.username if item.assignee else "N/A") | replace("'", "\\'") }}'
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ];

      // Helper for badges
      const getStatusBadge = (status) => {
        const map = {
          'open': { class: 'warning', text: 'Aberto' },
          'in_progress': { class: 'info', text: 'Em Andamento' },
          'pending': { class: 'secondary', text: 'Pendente' },
          'closed': { class: 'success', text: 'Fechado' },
          'canceled': { class: 'error', text: 'Cancelado' }
        };
        const s = map[status] || { class: 'secondary', text: status };
        return `<span class="status-indicator ${s.class}">${s.text}</span>`;
      };

      const getPriorityBadge = (priority) => {
        const map = {
          'low': { class: 'secondary', text: 'Baixa' },
          'normal': { class: 'info', text: 'Normal' },
          'high': { class: 'warning', text: 'Alta' },
          'critical': { class: 'error', text: 'Cr√≠tica' }
        };
        const s = map[priority] || { class: 'secondary', text: priority };
        return `<span class="badge badge-${s.class}">${s.text}</span>`;
      };

      // Data Table
      const dataTable = new ISP_Components.DataTable({
        container: '#table-container',
        columns: [
          { field: 'protocol', label: 'Protocolo', sortable: true },
          { field: 'client', label: 'Cliente', sortable: true },
          { field: 'subject', label: 'Assunto' },
          { field: 'category', label: 'Categoria' },
          { 
            field: 'priority', 
            label: 'Prioridade', 
            render: (val) => getPriorityBadge(val) 
          },
          { 
            field: 'status', 
            label: 'Status', 
            render: (val) => getStatusBadge(val) 
          },
          { field: 'created_at', label: 'Abertura', sortable: true },
          { field: 'assignee', label: 'Atendente' },
          {
            field: 'actions',
            label: 'A√ß√µes',
            render: (val, row) => `
              <div class="table-actions">
                <a href="/admin/support/tickets/${row.id}" class="btn-icon" title="Ver Detalhes">
                  <i class="fas fa-eye"></i> üëÅÔ∏è
                </a>
              </div>
            `
          }
        ],
        data: ticketsData,
        pagination: true,
        itemsPerPage: 10
      });

      // Modal Handling
      document.querySelectorAll('[data-modal-target="modal-ticket"]').forEach(btn => {
        btn.addEventListener('click', () => {
          ISP_ERP.openModal('modal-ticket');
        });
      });

      document.querySelectorAll('[data-modal-close]').forEach(btn => {
        btn.addEventListener('click', () => {
          ISP_ERP.closeModal('modal-ticket');
        });
      });
      
      // Close modal on outside click
      window.addEventListener('click', (e) => {
        const modal = document.getElementById('modal-ticket');
        if (e.target === modal) {
          ISP_ERP.closeModal('modal-ticket');
        }
      });
    });
  </script>
</body>
</html>
