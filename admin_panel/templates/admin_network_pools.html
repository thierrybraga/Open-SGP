<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pools IP - ISP ERP</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}" />
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-components.css') }}" />
</head>
<body>
  <a href="#main-content" class="skip-link">Pular para o conte√∫do principal</a>
  {% include 'components/navbar.html' %}

  <main id="main-content" class="main-content">
    <div class="container">
      <nav aria-label="Breadcrumb" class="breadcrumb">
        <span class="breadcrumb-item"><a href="/">Home</a></span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item"><a href="/admin/network">Rede</a></span><span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">Pools IP</span>
      </nav>

      <header class="page-header">
        <div class="page-header-content">
          <h1 class="page-title">Pools IP</h1>
          <p class="page-subtitle">Gerencie os pools de endere√ßos IP</p>
        </div>
        <div class="page-header-actions">
          <button type="button" class="btn btn-primary" data-modal-target="modal-pool">
            <span aria-hidden="true">‚ûï</span>
            Novo Pool
          </button>
        </div>
      </header>

      

      <div id="filter-container"></div>

      <div class="card">
        <div class="card-body">
          <div id="table-container"></div>
        </div>
      </div>
      <div id="pagination-container"></div>
    </div>
  </main>

  <div id="modal-pool" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Novo Pool</h2>
        <button class="modal-close" aria-label="Fechar modal">‚úï</button>
      </div>
      <div class="modal-body">
        <form id="form-pool" method="post" action="{{ url_for('admin_network_pools') }}" data-validate>
          <input type="hidden" name="id" id="pool-id" />
          
          <div class="form-group">
            <label for="name" class="form-label required">Name</label>
            <input type="text" id="name" name="name" class="form-control" required />
          </div>
          <div class="form-group">
            <label for="cidr" class="form-label required">CIDR</label>
            <input type="text" id="cidr" name="cidr" class="form-control" placeholder="192.168.100.0/24" required />
          </div>
          <div class="form-group">
            <label for="type" class="form-label required">Type</label>
            <select id="type" name="type" class="form-control" required>
              <option value="dynamic">Din√¢mico</option>
              <option value="static">Est√°tico</option>
              <option value="cgnat">CGNAT</option>
            </select>
          </div>
          <div class="form-group">
            <label for="gateway" class="form-label required">Gateway</label>
            <input type="text" id="gateway" name="gateway" class="form-control" required />
          </div>
          <div class="form-group">
            <label for="dns_primary" class="form-label required">DNS Primary</label>
            <input type="text" id="dns_primary" name="dns_primary" class="form-control" value="8.8.8.8" required />
          </div>
          <div class="form-group">
            <label for="dns_secondary" class="form-label required">DNS Secondary</label>
            <input type="text" id="dns_secondary" name="dns_secondary" class="form-control" value="8.8.4.4" required />
          </div>
          <div class="form-group">
            <label for="device_id" class="form-label">Device (Optional)</label>
            <select id="device_id" name="device_id" class="form-control">
              <option value="">Nenhum</option>
              {% for d in devices %}
              <option value="{{ d.id }}">{{ d.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="vlan_id" class="form-label">VLAN (Optional)</label>
            <select id="vlan_id" name="vlan_id" class="form-control">
              <option value="">Nenhuma</option>
              {% for v in vlans %}
              <option value="{{ v.id }}">{{ v.name }} ({{ v.vlan_id }})</option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-modal-close>Cancelar</button>
        <button type="submit" form="form-pool" class="btn btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  {% include 'components/footer.html' %}
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script src="{{ url_for('static', filename='js/navbar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/footer.js') }}"></script>
  <script src="{{ url_for('static', filename='js/components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/advanced-components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      
      const sampleData = [
        {% for item in items %}
        {
          id: {{ item.id }},
          name: {{ item.name | tojson }},
          cidr: {{ item.cidr | tojson }},
          type: {{ item.type | tojson }},
          gateway: {{ item.gateway | tojson }},
          dns_primary: {{ item.dns_primary | tojson }},
          dns_secondary: {{ item.dns_secondary | tojson }},
          device_id: {{ item.device_id or 'null' }},
          vlan_id: {{ item.vlan_id or 'null' }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ];

      const filterPanel = new ISP_Components.FilterPanel({
        container: '#filter-container',
        filters: [
          { type: 'text', name: 'name', label: 'Nome', placeholder: 'Filtrar por nome' },
          { type: 'select', name: 'type', label: 'Tipo', options: [
            { value: 'dynamic', label: 'Din√¢mico' },
            { value: 'static', label: 'Est√°tico' },
            { value: 'cgnat', label: 'CGNAT' }
          ]}
        ],
        onApply: (filters) => {
          const params = new URLSearchParams(window.location.search);
          Object.keys(filters).forEach(key => {
             if(filters[key]) params.set(key, filters[key]);
             else params.delete(key);
          });
          window.location.search = params.toString();
        },
        onReset: () => {
          window.location.href = window.location.pathname;
        }
      });

      const dataTable = new ISP_Components.DataTable({
        container: '#table-container',
        columns: [
          { field: 'id', label: 'Id', sortable: true }, 
          { field: 'name', label: 'Name', sortable: true }, 
          { field: 'cidr', label: 'CIDR', sortable: true }, 
          { field: 'type', label: 'Type', sortable: true },
          { field: 'gateway', label: 'Gateway', sortable: true }
        ],
        data: sampleData,
        actions: [
          { name: 'edit', label: 'Editar', icon: '‚úèÔ∏è', handler: (row) => editPool(row) },
          { name: 'delete', label: 'Excluir', icon: 'üóëÔ∏è', variant: 'danger', handler: (row) => deletePool(row) }
        ],
        emptyMessage: 'Nenhum registro encontrado'
      });
      
      new ISP_Components.Pagination({
        container: '#pagination-container',
        total: sampleData.length,
        currentPage: 1,
        pageSize: 10
      });
      
      const modal = document.getElementById('modal-pool');
      const form = document.getElementById('form-pool');

      // Modal triggers
      document.querySelectorAll('[data-modal-target="modal-pool"]').forEach(btn => {
        btn.addEventListener('click', () => {
          form.reset();
          document.getElementById('pool-id').value = '';
          document.getElementById('modal-title').textContent = 'Novo Pool';
          ISP_ERP.openModal('modal-pool');
        });
      });

      document.querySelectorAll('[data-modal-close]').forEach(btn => {
        btn.addEventListener('click', () => {
          ISP_ERP.closeModal('modal-pool');
        });
      });
      
      const formValidator = new ISP_Components.FormValidator('#form-pool', {});
      
      window.editPool = function(row) {
        document.getElementById('pool-id').value = row.id;
        document.getElementById('name').value = row.name;
        document.getElementById('cidr').value = row.cidr;
        document.getElementById('type').value = row.type;
        document.getElementById('gateway').value = row.gateway;
        document.getElementById('dns_primary').value = row.dns_primary || '8.8.8.8';
        document.getElementById('dns_secondary').value = row.dns_secondary || '8.8.4.4';
        document.getElementById('device_id').value = row.device_id || '';
        document.getElementById('vlan_id').value = row.vlan_id || '';
        
        document.getElementById('modal-title').textContent = 'Editar Pool';
        ISP_ERP.openModal('modal-pool');
      };
      
      window.deletePool = function(row) {
        ISP_ERP.confirm(`Excluir Pool "${row.name}"?`, c => {
          if(c) {
             fetch(`/admin/network/pools/${row.id}/delete`, { method: 'POST' })
                .then(r => r.json())
                .then(d => {
                    if(d.success) {
                        ISP_AdvancedComponents.Toast.success('Pool exclu√≠do!'); 
                        location.reload(); 
                    } else {
                        ISP_AdvancedComponents.Toast.error('Erro ao excluir Pool');
                    }
                });
          }
        });
      };
    });
  </script>
</body>
</html>
