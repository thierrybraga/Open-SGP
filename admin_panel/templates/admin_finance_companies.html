<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Empresas - ISP ERP</title>

  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}" />
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-components.css') }}" />
</head>
<body>
  <!-- Skip Link -->
  <a href="#main-content" class="skip-link">Pular para o conteÃºdo principal</a>

  <!-- Navigation -->
  {% include 'components/navbar.html' %}

  <!-- Main Content -->
  <main id="main-content" class="main-content">
    <div class="container">

      <!-- Breadcrumbs -->
      <nav aria-label="Breadcrumb" class="breadcrumb">
        <span class="breadcrumb-item">
          <a href="/">Home</a>
        </span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">
          <a href="/admin/finance">Financeiro</a>
        </span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">Empresas</span>
      </nav>

      <!-- Page Header -->
      <header class="page-header">
        <div class="page-header-content">
          <h1 class="page-title">Empresas</h1>
          <p class="page-subtitle">Gerencie as empresas do grupo para emissÃ£o de documentos fiscais</p>
        </div>
        <div class="page-header-actions">
          <button type="button" class="btn btn-primary" data-modal-target="modal-company">
            <span aria-hidden="true">âž•</span>
            Nova Empresa
          </button>
        </div>
      </header>

      <div id="filter-container"></div>

      <!-- Data Table -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Lista de Empresas</h2>
          <div class="card-actions">
            <button type="button" class="btn btn-sm btn-secondary" onclick="refreshData()" aria-label="Atualizar dados">
              <span aria-hidden="true">ðŸ”„</span>
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="table-container"></div>
        </div>
      </div>

      <!-- Pagination -->
      <div id="pagination-container"></div>

    </div>
  </main>

  <!-- Modal: New/Edit Company -->
  <div id="modal-company" class="modal-overlay" style="display: none;">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Nova Empresa</h2>
        <button class="modal-close" aria-label="Fechar modal">âœ•</button>
      </div>
      <div class="modal-body">
        <form id="form-company" method="post" action="{{ url_for('admin_finance_companies') }}" data-validate>
          <input type="hidden" name="id" id="company-id" />

          <div class="form-row">
            <div class="form-group">
              <label for="name" class="form-label required">Nome Fantasia</label>
              <input type="text" id="name" name="name" class="form-control" required aria-required="true" placeholder="Ex: ISP Telecom" />
            </div>

            <div class="form-group">
              <label for="legal_name" class="form-label required">RazÃ£o Social</label>
              <input type="text" id="legal_name" name="legal_name" class="form-control" required aria-required="true" placeholder="Ex: ISP Telecom LTDA" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="document" class="form-label required">CNPJ</label>
              <input type="text" id="document" name="document" class="form-control" required aria-required="true" placeholder="00.000.000/0000-00" maxlength="18" />
            </div>

            <div class="form-group">
              <label for="state_registration" class="form-label">InscriÃ§Ã£o Estadual</label>
              <input type="text" id="state_registration" name="state_registration" class="form-control" placeholder="Opcional" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="email" class="form-label required">E-mail</label>
              <input type="email" id="email" name="email" class="form-control" required aria-required="true" placeholder="contato@empresa.com" />
            </div>

            <div class="form-group">
              <label for="phone" class="form-label required">Telefone</label>
              <input type="tel" id="phone" name="phone" class="form-control" required aria-required="true" placeholder="(00) 0000-0000" />
            </div>
          </div>

          <div class="form-group">
            <label for="address" class="form-label">EndereÃ§o Completo</label>
            <textarea id="address" name="address" class="form-control" rows="2" placeholder="Rua, nÃºmero, bairro, cidade - UF"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="zipcode" class="form-label">CEP</label>
              <input type="text" id="zipcode" name="zipcode" class="form-control" placeholder="00000-000" maxlength="9" />
            </div>

            <div class="form-group">
              <label for="website" class="form-label">Website</label>
              <input type="url" id="website" name="website" class="form-control" placeholder="https://www.empresa.com" />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="active" name="active" checked />
              Empresa ativa
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-modal-close>Cancelar</button>
        <button type="submit" form="form-company" class="btn btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  {% include 'components/footer.html' %}

  <!-- JavaScript -->
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script src="{{ url_for('static', filename='js/navbar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/footer.js') }}"></script>
  <script src="{{ url_for('static', filename='js/components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/advanced-components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

  <script>
    // Sample data
    const sampleData = {{ items|tojson|safe if items else '[]' }};

    document.addEventListener('DOMContentLoaded', function() {
      
      const filterPanel = new ISP_Components.FilterPanel({
        container: '#filter-container',
        filters: [
          { type: 'text', name: 'name', label: 'Nome', placeholder: 'Filtrar por nome' },
          { type: 'text', name: 'document', label: 'CNPJ', placeholder: 'Filtrar por CNPJ' }
        ],
        onApply: (filters) => {
          const params = new URLSearchParams(window.location.search);
          Object.keys(filters).forEach(key => {
             if(filters[key]) params.set(key, filters[key]);
             else params.delete(key);
          });
          window.location.search = params.toString();
        },
        onReset: () => {
          window.location.href = window.location.pathname;
        }
      });

      // Initialize Data Table
      const dataTable = new ISP_Components.DataTable({
        container: '#table-container',
        columns: [
          { field: 'id', label: 'ID', sortable: true },
          { field: 'name', label: 'Nome Fantasia', sortable: true },
          { field: 'legal_name', label: 'RazÃ£o Social', sortable: true },
          { field: 'document', label: 'CNPJ', sortable: true },
          { field: 'email', label: 'E-mail', sortable: true },
          { field: 'phone', label: 'Telefone', sortable: true }
        ],
        data: sampleData,
        selectable: true,
        actions: [
          {
            name: 'edit',
            label: 'Editar',
            icon: 'âœï¸',
            handler: function(row) {
              editCompany(row);
            }
          },
          {
            name: 'delete',
            label: 'Excluir',
            icon: 'ðŸ—‘ï¸',
            variant: 'danger',
            handler: function(row) {
              deleteCompany(row);
            }
          }
        ],
        onSelect: function(selectedIds) {
          console.log('Selected:', selectedIds);
          if (selectedIds.length > 0) {
            ISP_AdvancedComponents.Toast.info(`${selectedIds.length} empresa(s) selecionada(s)`);
          }
        },
        emptyMessage: 'Nenhuma empresa cadastrada'
      });

      // Initialize Pagination
      const pagination = new ISP_Components.Pagination({
        container: '#pagination-container',
        total: sampleData.length,
        currentPage: 1,
        pageSize: 10,
        onPageChange: function(page, pageSize) {
          console.log('Page changed:', page, pageSize);
          ISP_AdvancedComponents.Toast.info(`Carregando pÃ¡gina ${page}...`);
        }
      });

      // Form validation
      const formValidator = new ISP_Components.FormValidator('#form-company', {
        name: {
          required: true,
          minLength: 3,
          messages: {
            required: 'Nome fantasia Ã© obrigatÃ³rio',
            minLength: 'Nome deve ter no mÃ­nimo 3 caracteres'
          }
        },
        legal_name: {
          required: true,
          minLength: 3,
          messages: {
            required: 'RazÃ£o social Ã© obrigatÃ³ria',
            minLength: 'RazÃ£o social deve ter no mÃ­nimo 3 caracteres'
          }
        },
        document: {
          required: true,
          pattern: /^\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}$/,
          messages: {
            required: 'CNPJ Ã© obrigatÃ³rio',
            pattern: 'Digite um CNPJ vÃ¡lido (00.000.000/0000-00)'
          }
        },
        email: {
          required: true,
          email: true,
          messages: {
            required: 'E-mail Ã© obrigatÃ³rio',
            email: 'Digite um e-mail vÃ¡lido'
          }
        },
        phone: {
          required: true,
          messages: {
            required: 'Telefone Ã© obrigatÃ³rio'
          }
        }
      });

      // CNPJ mask
      document.getElementById('document').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 14) value = value.slice(0, 14);

        if (value.length >= 2) {
          value = value.replace(/^(\d{2})(\d)/, '$1.$2');
        }
        if (value.length >= 6) {
          value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
        }
        if (value.length >= 9) {
          value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
        }
        if (value.length >= 13) {
          value = value.replace(/\/(\d{4})(\d)/, '/$1-$2');
        }
        e.target.value = value;
      });

      // Edit Company Function
      window.editCompany = function(row) {
        document.getElementById('company-id').value = row.id;
        document.getElementById('name').value = row.name;
        document.getElementById('legal_name').value = row.legal_name;
        document.getElementById('document').value = row.document;
        document.getElementById('email').value = row.email;
        document.getElementById('phone').value = row.phone;
        document.getElementById('active').checked = row.is_active !== false;

        document.getElementById('modal-title').textContent = 'Editar Empresa';
        ISP_ERP.openModal('modal-company');
      };

      // Reset modal on close
      document.querySelectorAll('[data-modal-close]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('form-company').reset();
            document.getElementById('company-id').value = '';
            document.getElementById('modal-title').textContent = 'Nova Empresa';
        });
      });

      // Delete Company Function
      window.deleteCompany = function(row) {
        ISP_ERP.confirm('Tem certeza que deseja excluir esta empresa?', (confirmed) => {
          if (confirmed) {
             // In a real app, we would make an AJAX call here
             // fetch('/admin/finance/companies/' + row.id, { method: 'DELETE' })...
             ISP_AdvancedComponents.Toast.success('Empresa excluÃ­da com sucesso (demo)');
             location.reload();
          }
        });
      };

      // Phone mask
      document.getElementById('phone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.slice(0, 11);

        if (value.length >= 2) {
          value = value.replace(/^(\d{2})(\d)/, '($1) $2');
        }
        if (value.length >= 7) {
          if (value.length === 10) {
            value = value.replace(/(\d{4})(\d{4})$/, '$1-$2');
          } else {
            value = value.replace(/(\d{5})(\d{4})$/, '$1-$2');
          }
        }

        e.target.value = value;
      });

      // CEP mask
      document.getElementById('zipcode').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 8) value = value.slice(0, 8);

        if (value.length >= 5) {
          value = value.replace(/^(\d{5})(\d)/, '$1-$2');
        }

        e.target.value = value;
      });

      // Form submission
      document.getElementById('form-company').addEventListener('submit', function(e) {
        e.preventDefault();

        if (!formValidator.validate()) {
          return;
        }

        const formData = new FormData(this);

        // Submit to backend
        fetch(window.location.pathname, {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          ISP_ERP.closeModal('modal-company');
          ISP_AdvancedComponents.Toast.success('Empresa salva com sucesso!');
          location.reload();
        })
        .catch(error => {
          ISP_AdvancedComponents.Toast.error('Erro ao salvar empresa');
          console.error('Error:', error);
        });
      });

      // Edit company
      window.editCompany = function(row) {
        document.getElementById('company-id').value = row.id;
        document.getElementById('name').value = row.name;
        document.getElementById('legal_name').value = row.legal_name;
        document.getElementById('document').value = row.document;
        document.getElementById('email').value = row.email;
        document.getElementById('phone').value = row.phone;
        document.getElementById('active').checked = row.active !== false;

        document.getElementById('modal-title').textContent = 'Editar Empresa';
        ISP_ERP.openModal('modal-company');
      };

      // Delete company
      window.deleteCompany = function(row) {
        ISP_ERP.confirm(
          `Tem certeza que deseja excluir a empresa "${row.name}"?`,
          function(confirmed) {
            if (confirmed) {
              fetch(`/admin/finance/companies/${row.id}/delete`, {
                method: 'POST'
              })
              .then(response => response.json())
              .then(data => {
                ISP_AdvancedComponents.Toast.success('Empresa excluÃ­da com sucesso!');
                location.reload();
              })
              .catch(error => {
                ISP_AdvancedComponents.Toast.error('Erro ao excluir empresa');
                console.error('Error:', error);
              });
            }
          }
        );
      };

      // Refresh data
      window.refreshData = function() {
        ISP_AdvancedComponents.Toast.info('Atualizando dados...', {
          duration: 1500
        });
        setTimeout(() => {
          location.reload();
        }, 1500);
      };

      // Reset modal when closed
      document.querySelectorAll('[data-modal-close]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.getElementById('form-company').reset();
          formValidator.reset();
          document.getElementById('modal-title').textContent = 'Nova Empresa';
        });
      });

    });
  </script>

</body>
</html>
