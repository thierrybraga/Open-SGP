<!--
Arquivo: admin_panel/templates/admin_service_order_detail.html

Responsabilidade:
Detalhes da Ordem de Serviço, checklist e ações de encerramento.

Integrações:
- admin_panel/app.py
-->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>O.S. #{{ order.id }} - ISP ERP</title>

  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}" />
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-components.css') }}" />
</head>
<body>
  <!-- Skip Link -->
  <a href="#main-content" class="skip-link">Pular para o conteúdo principal</a>

  <!-- Navigation -->
  {% include 'components/navbar.html' %}

  <!-- Main Content -->
  <main id="main-content" class="main-content">
    <div class="container">

      <!-- Breadcrumbs -->
      <nav aria-label="Breadcrumb" class="breadcrumb">
        <span class="breadcrumb-item">
          <a href="/">Home</a>
        </span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">
          <a href="/admin/service-orders">Ordens de Serviço</a>
        </span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">#{{ order.id }}</span>
      </nav>

      <!-- Page Header -->
      <header class="page-header">
        <div class="page-header-content">
          <h1 class="page-title">Ordem de Serviço #{{ order.id }}</h1>
          <p class="page-subtitle">
            {% if order.type == 'install' %}Instalação
            {% elif order.type == 'repair' %}Reparo
            {% elif order.type == 'relocation' %}Mudança de Endereço
            {% elif order.type == 'removal' %}Retirada
            {% else %}{{ order.type }}{% endif %}
            - {{ order.client.name }}
          </p>
        </div>
        <div class="page-header-actions">
          {% if order.status != 'completed' and order.status != 'canceled' %}
          <button type="button" class="btn btn-success" onclick="document.getElementById('form-complete').submit()">
            <span aria-hidden="true">✅</span>
            Concluir O.S.
          </button>
          {% endif %}
        </div>
      </header>

      <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 2rem;">
        
        <!-- Main Column -->
        <div>
          <!-- Details -->
          <div class="card mb-4">
            <div class="card-header">
              <h2 class="card-title">Detalhes</h2>
            </div>
            <div class="card-body">
              <form id="form-update" method="post" action="{{ url_for('admin_service_order_update', order_id=order.id) }}">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Técnico</label>
                    <input type="text" name="technician_name" class="form-control" value="{{ order.technician_name or '' }}" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Agendamento</label>
                    <input type="datetime-local" name="scheduled_at" class="form-control" value="{{ order.scheduled_at.strftime('%Y-%m-%dT%H:%M') if order.scheduled_at else '' }}" />
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Observações</label>
                  <textarea name="notes" class="form-control" rows="3">{{ order.notes or '' }}</textarea>
                </div>
                <button type="submit" class="btn btn-outline-primary btn-sm">Salvar Alterações</button>
              </form>
            </div>
          </div>

          <!-- Items / Checklist -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Checklist / Itens</h2>
            </div>
            <div class="card-body">
              <ul class="list-group">
                {% for item in order.items %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <input type="checkbox" {% if item.done %}checked{% endif %} disabled />
                    {{ item.description }} (x{{ item.quantity }})
                  </div>
                </li>
                {% else %}
                <li class="list-group-item text-muted">Nenhum item adicionado.</li>
                {% endfor %}
              </ul>
              
              <hr>
              
              <form method="post" action="{{ url_for('admin_service_order_add_item', order_id=order.id) }}" class="form-row align-items-end">
                <div class="form-group flex-grow-1">
                  <label class="form-label">Novo Item</label>
                  <input type="text" name="description" class="form-control" required placeholder="Descrição" />
                </div>
                <div class="form-group" style="width: 100px;">
                  <label class="form-label">Qtd</label>
                  <input type="number" name="quantity" class="form-control" value="1" min="1" required />
                </div>
                <div class="form-group">
                  <button type="submit" class="btn btn-secondary">Adicionar</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Side Column: Info & Actions -->
        <div>
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Status</h2>
            </div>
            <div class="card-body">
              <div class="text-center mb-4">
                <span class="status-indicator 
                  {% if order.status == 'completed' %}success
                  {% elif order.status == 'canceled' %}error
                  {% elif order.status == 'open' %}warning
                  {% else %}info{% endif %}
                  large">
                  {{ order.status | upper }}
                </span>
              </div>

              <dl class="description-list">
                <dt>Criado em</dt>
                <dd>{{ order.created_at.strftime("%d/%m/%Y %H:%M") }}</dd>
                
                <dt>Executado em</dt>
                <dd>{{ order.executed_at.strftime("%d/%m/%Y %H:%M") if order.executed_at else "-" }}</dd>

                <dt>Prioridade</dt>
                <dd>{{ order.priority }}</dd>
              </dl>

              <form id="form-complete" method="post" action="{{ url_for('admin_service_order_complete', order_id=order.id) }}" style="display: none;"></form>
              
              {% if order.status != 'canceled' and order.status != 'completed' %}
              <form method="post" action="{{ url_for('admin_service_order_cancel', order_id=order.id) }}" onsubmit="return confirm('Tem certeza que deseja cancelar esta O.S.?')">
                <button type="submit" class="btn btn-outline-danger btn-block mt-4">Cancelar O.S.</button>
              </form>
              {% endif %}
            </div>
          </div>
          
          {% if order.client %}
          <div class="card mt-4">
            <div class="card-header">
              <h2 class="card-title">Cliente</h2>
            </div>
            <div class="card-body">
              <p><strong>{{ order.client.name }}</strong></p>
              <p class="text-muted">{{ order.client.city }} - {{ order.client.state }}</p>
              <a href="/admin/clients/{{ order.client.id }}" class="btn btn-link px-0">Ver Cadastro</a>
            </div>
          </div>
          {% endif %}
        </div>

      </div>

    </div>
  </main>

  <!-- Footer -->
  {% include 'components/footer.html' %}

  <!-- JavaScript -->
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script src="{{ url_for('static', filename='js/navbar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/footer.js') }}"></script>
  <script src="{{ url_for('static', filename='js/components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/advanced-components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

</body>
</html>
