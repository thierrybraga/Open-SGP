<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portadores - ISP ERP</title>

  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}" />
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-components.css') }}" />
</head>
<body>
  <!-- Skip Link -->
  <a href="#main-content" class="skip-link">Pular para o conteÃºdo principal</a>

  <!-- Navigation -->
  {% include 'components/navbar.html' %}

  <!-- Main Content -->
  <main id="main-content" class="main-content">
    <div class="container">

      <!-- Breadcrumbs -->
      <nav aria-label="Breadcrumb" class="breadcrumb">
        <span class="breadcrumb-item">
          <a href="/">Home</a>
        </span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">
          <a href="/admin/finance">Financeiro</a>
        </span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">Portadores</span>
      </nav>

      <!-- Page Header -->
      <header class="page-header">
        <div class="page-header-content">
          <h1 class="page-title">Portadores</h1>
          <p class="page-subtitle">Gerencie os portadores bancÃ¡rios para emissÃ£o de boletos</p>
        </div>
        <div class="page-header-actions">
          <button type="button" class="btn btn-primary" data-modal-target="modal-carrier">
            <span aria-hidden="true">âž•</span>
            Novo Portador
          </button>
        </div>
      </header>

      <div id="filter-container"></div>

      <!-- Data Table -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Lista de Portadores</h2>
          <div class="card-actions">
            <button type="button" class="btn btn-sm btn-secondary" onclick="refreshData()" aria-label="Atualizar dados">
              <span aria-hidden="true">ðŸ”„</span>
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="table-container"></div>
        </div>
      </div>

      <!-- Pagination -->
      <div id="pagination-container"></div>

    </div>
  </main>

  <!-- Modal: New/Edit Carrier -->
  <div id="modal-carrier" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Novo Portador</h2>
        <button class="modal-close" aria-label="Fechar modal">âœ•</button>
      </div>
      <div class="modal-body">
        <form id="form-carrier" method="post" action="{{ url_for('admin_finance_carriers') }}" data-validate>
          <input type="hidden" name="id" id="carrier-id" />

          <div class="form-group">
            <label for="name" class="form-label required">Nome do Portador</label>
            <input type="text" id="name" name="name" class="form-control" required aria-required="true" placeholder="Ex: Banco Principal" />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="bank_code" class="form-label required">CÃ³digo do Banco</label>
              <input type="text" id="bank_code" name="bank_code" class="form-control" required aria-required="true" placeholder="Ex: 001" maxlength="3" />
            </div>

            <div class="form-group">
              <label for="agency" class="form-label required">AgÃªncia</label>
              <input type="text" id="agency" name="agency" class="form-control" required aria-required="true" placeholder="Ex: 1234" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="account" class="form-label required">Conta</label>
              <input type="text" id="account" name="account" class="form-control" required aria-required="true" placeholder="Ex: 12345-6" />
            </div>

            <div class="form-group">
              <label for="wallet" class="form-label required">Carteira</label>
              <input type="text" id="wallet" name="wallet" class="form-control" required aria-required="true" placeholder="Ex: 18" />
            </div>
          </div>

          <div class="form-group">
            <label for="cnab_layout" class="form-label required">Layout CNAB</label>
            <select id="cnab_layout" name="cnab_layout" class="form-select" required aria-required="true">
              <option value="">Selecione...</option>
              <option value="240">CNAB 240</option>
              <option value="400" selected>CNAB 400</option>
            </select>
          </div>


        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-modal-close>Cancelar</button>
        <button type="submit" form="form-carrier" class="btn btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  {% include 'components/footer.html' %}

  <!-- JavaScript -->
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script src="{{ url_for('static', filename='js/navbar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/footer.js') }}"></script>
  <script src="{{ url_for('static', filename='js/components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/advanced-components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

  <script>
    // Sample data
    const sampleData = {{ items|tojson|safe if items else '[]' }};

    document.addEventListener('DOMContentLoaded', function() {
      
      const filterPanel = new ISP_Components.FilterPanel({
        container: '#filter-container',
        filters: [
          { type: 'text', name: 'name', label: 'Nome', placeholder: 'Filtrar por nome' },
          { type: 'text', name: 'bank_code', label: 'CÃ³digo Banco', placeholder: 'Filtrar por cÃ³digo' }
        ],
        onApply: (filters) => {
          const params = new URLSearchParams(window.location.search);
          Object.keys(filters).forEach(key => {
             if(filters[key]) params.set(key, filters[key]);
             else params.delete(key);
          });
          window.location.search = params.toString();
        },
        onReset: () => {
          window.location.href = window.location.pathname;
        }
      });

      // Initialize Data Table
      const dataTable = new ISP_Components.DataTable({
        container: '#table-container',
        columns: [
          { field: 'id', label: 'ID', sortable: true },
          { field: 'name', label: 'Nome', sortable: true },
          { field: 'bank_code', label: 'Banco', sortable: true },
          { field: 'agency', label: 'AgÃªncia', sortable: true },
          { field: 'account', label: 'Conta', sortable: true },
          { field: 'wallet', label: 'Carteira', sortable: true },
          { field: 'cnab_layout', label: 'Layout', sortable: true }
        ],
        data: sampleData,
        selectable: true,
        actions: [
          {
            name: 'edit',
            label: 'Editar',
            icon: 'âœï¸',
            handler: function(row) {
              editCarrier(row);
            }
          },
          {
            name: 'delete',
            label: 'Excluir',
            icon: 'ðŸ—‘ï¸',
            variant: 'danger',
            handler: function(row) {
              deleteCarrier(row);
            }
          }
        ],
        onSelect: function(selectedIds) {
          console.log('Selected:', selectedIds);
          if (selectedIds.length > 0) {
            ISP_AdvancedComponents.Toast.info(`${selectedIds.length} portador(es) selecionado(s)`);
          }
        },
        emptyMessage: 'Nenhum portador cadastrado'
      });

      // Initialize Pagination
      const pagination = new ISP_Components.Pagination({
        container: '#pagination-container',
        total: sampleData.length,
        currentPage: 1,
        pageSize: 10,
        onPageChange: function(page, pageSize) {
          console.log('Page changed:', page, pageSize);
          ISP_AdvancedComponents.Toast.info(`Carregando pÃ¡gina ${page}...`);
        }
      });

      // Form validation
      const formValidator = new ISP_Components.FormValidator('#form-carrier', {
        name: {
          required: true,
          minLength: 3,
          messages: {
            required: 'Nome Ã© obrigatÃ³rio',
            minLength: 'Nome deve ter no mÃ­nimo 3 caracteres'
          }
        },
        bank_code: {
          required: true,
          pattern: /^\d{3}$/,
          messages: {
            required: 'CÃ³digo do banco Ã© obrigatÃ³rio',
            pattern: 'Digite um cÃ³digo de 3 dÃ­gitos'
          }
        },
        agency: {
          required: true,
          messages: {
            required: 'AgÃªncia Ã© obrigatÃ³ria'
          }
        },
        account: {
          required: true,
          messages: {
            required: 'Conta Ã© obrigatÃ³ria'
          }
        },
        wallet: {
          required: true,
          messages: {
            required: 'Carteira Ã© obrigatÃ³ria'
          }
        },
        cnab_layout: {
          required: true,
          messages: {
            required: 'Selecione o layout CNAB'
          }
        }
      });

      // Form submission
      document.getElementById('form-carrier').addEventListener('submit', function(e) {
        e.preventDefault();

        if (!formValidator.validate()) {
          return;
        }

        const formData = new FormData(this);

        // Submit to backend
        fetch(window.location.pathname, {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          ISP_ERP.closeModal('modal-carrier');
          ISP_AdvancedComponents.Toast.success('Portador salvo com sucesso!');
          location.reload();
        })
        .catch(error => {
          ISP_AdvancedComponents.Toast.error('Erro ao salvar portador');
          console.error('Error:', error);
        });
      });

      // Edit carrier
      window.editCarrier = function(row) {
        document.getElementById('carrier-id').value = row.id;
        document.getElementById('name').value = row.name;
        document.getElementById('bank_code').value = row.bank_code;
        document.getElementById('agency').value = row.agency;
        document.getElementById('account').value = row.account;
        document.getElementById('wallet').value = row.wallet;
        document.getElementById('cnab_layout').value = row.cnab_layout;
        document.getElementById('agreement').value = row.agreement || '';

        document.getElementById('modal-title').textContent = 'Editar Portador';
        ISP_ERP.openModal('modal-carrier');
      };

      // Delete carrier
      window.deleteCarrier = function(row) {
        ISP_ERP.confirm(
          `Tem certeza que deseja excluir o portador "${row.name}"?`,
          function(confirmed) {
            if (confirmed) {
              fetch(`/admin/finance/carriers/${row.id}/delete`, {
                method: 'POST'
              })
              .then(response => response.json())
              .then(data => {
                ISP_AdvancedComponents.Toast.success('Portador excluÃ­do com sucesso!');
                location.reload();
              })
              .catch(error => {
                ISP_AdvancedComponents.Toast.error('Erro ao excluir portador');
                console.error('Error:', error);
              });
            }
          }
        );
      };

      // Refresh data
      window.refreshData = function() {
        ISP_AdvancedComponents.Toast.info('Atualizando dados...', {
          duration: 1500
        });
        setTimeout(() => {
          location.reload();
        }, 1500);
      };

      // Reset modal when closed
      document.querySelectorAll('[data-modal-close]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.getElementById('form-carrier').reset();
          formValidator.reset();
          document.getElementById('modal-title').textContent = 'Novo Portador';
        });
      });

    });
  </script>

</body>
</html>
