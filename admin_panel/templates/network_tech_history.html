<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Histórico Técnico - ISP ERP</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}" />
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-components.css') }}" />
</head>
<body>
  <a href="#main-content" class="skip-link">Pular para o conteúdo principal</a>
  {% include 'components/navbar.html' %}

  <main id="main-content" class="main-content">
    <div class="container">
      <nav aria-label="Breadcrumb" class="breadcrumb">
        <span class="breadcrumb-item"><a href="/">Home</a></span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item"><a href="/admin/network/assignments">Atribuições</a></span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">Histórico Técnico (Contrato {{ contract_id }})</span>
      </nav>

      <header class="page-header">
        <div class="page-header-content">
          <h1 class="page-title">Histórico Técnico</h1>
          <p class="page-subtitle">Visualize o histórico de intervenções técnicas para o contrato {{ contract_id }}</p>
        </div>
        <div class="page-header-actions">
          <button type="button" class="btn btn-primary" onclick="openModal()">
            <span aria-hidden="true">➕</span>
            Novo Registro
          </button>
        </div>
      </header>
      
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <div id="filter-container"></div>

      <div class="card">
        <div class="card-body">
          <div id="table-container"></div>
        </div>
      </div>
      <div id="pagination-container"></div>
    </div>
  </main>

  <div id="modal-history" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Novo Registro</h2>
        <button class="modal-close" aria-label="Fechar modal" onclick="closeModal()">✕</button>
      </div>
      <div class="modal-body">
        <form id="form-history" method="post" action="{{ url_for('network_tech_history', contract_id=contract_id) }}" data-validate>
          
          <div class="form-group">
            <label for="technician" class="form-label required">Técnico</label>
            <input type="text" id="technician" name="technician" class="form-control" required />
          </div>
          
          <div class="form-group">
            <label for="action" class="form-label required">Ação</label>
            <select id="action" name="action" class="form-control" required>
              <option value="maintenance">Manutenção</option>
              <option value="installation">Instalação</option>
              <option value="repair">Reparo</option>
              <option value="visit">Visita Técnica</option>
              <option value="remote_support">Suporte Remoto</option>
              <option value="other">Outro</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="description" class="form-label required">Descrição</label>
            <textarea id="description" name="description" class="form-control" rows="3" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
        <button type="submit" form="form-history" class="btn btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  {% include 'components/footer.html' %}
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script src="{{ url_for('static', filename='js/navbar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/footer.js') }}"></script>
  <script src="{{ url_for('static', filename='js/components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/advanced-components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

  <script>
    const sampleData = {{ items|tojson|safe if items else '[]' }};
    
    function openModal() {
        document.getElementById('modal-history').style.display = 'flex';
        document.getElementById('form-history').reset();
    }
    
    function closeModal() {
        document.getElementById('modal-history').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
      const dataTable = new ISP_AdvancedComponents.DataTable({
        container: '#table-container',
        columns: [
          { key: 'id', label: 'ID', sortable: true },
          { key: 'technician', label: 'Técnico', sortable: true },
          { key: 'action', label: 'Ação', sortable: true, render: (val) => {
              const map = {
                  'maintenance': 'Manutenção',
                  'installation': 'Instalação',
                  'repair': 'Reparo',
                  'visit': 'Visita Técnica',
                  'remote_support': 'Suporte Remoto',
                  'other': 'Outro'
              };
              return map[val] || val;
          }},
          { key: 'description', label: 'Descrição' },
          { key: 'occurred_at', label: 'Data', sortable: true, render: (val) => val ? new Date(val).toLocaleString('pt-BR') : '-' }
        ],
        data: sampleData,
        actions: [],
        showActionColumn: false,
        itemsPerPage: 10,
        language: {
            search: "Buscar:",
            perPage: "por página",
            noData: "Nenhum histórico encontrado",
            info: "Mostrando {start} a {end} de {total} registros"
        }
      });
      
      // Close modal when clicking outside
      document.getElementById('modal-history').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
      });
    });
  </script>
</body>
</html>
