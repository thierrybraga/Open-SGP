<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dispositivos de Rede - ISP ERP</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}" />
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-components.css') }}" />
</head>
<body>
  <a href="#main-content" class="skip-link">Pular para o conteúdo principal</a>
  {% include 'components/navbar.html' %}

  <main id="main-content" class="main-content">
    <div class="container">
      <nav aria-label="Breadcrumb" class="breadcrumb">
        <span class="breadcrumb-item"><a href="/">Home</a></span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item"><a href="/admin/network">Rede</a></span><span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">Dispositivos</span>
      </nav>

      <div class="space-y-6">
          <!-- Header -->
          <div class="flex justify-between items-center">
              <div>
                  <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Dispositivos de Rede</h1>
                  <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Gerenciamento de OLTs, Roteadores e Concentradores</p>
              </div>
              <button onclick="openDeviceModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                  <i class="fas fa-plus"></i>
                  Novo Dispositivo
              </button>
          </div>

          <!-- Filters -->
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
              <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div>
                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome</label>
                      <input type="text" name="name" value="{{ request.args.get('name') or '' }}" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700">
                  </div>
                  <div>
                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo</label>
                      <select name="type" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700">
                          <option value="">Todos</option>
                          <option value="router" {% if request.args.get('type') == 'router' %}selected{% endif %}>Roteador (Mikrotik)</option>
                          <option value="olt" {% if request.args.get('type') == 'olt' %}selected{% endif %}>OLT</option>
                          <option value="switch" {% if request.args.get('type') == 'switch' %}selected{% endif %}>Switch</option>
                      </select>
                  </div>
                  <div>
                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fabricante</label>
                      <select name="vendor" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700">
                          <option value="">Todos</option>
                          <option value="mikrotik" {% if request.args.get('vendor') == 'mikrotik' %}selected{% endif %}>Mikrotik</option>
                          <option value="huawei" {% if request.args.get('vendor') == 'huawei' %}selected{% endif %}>Huawei</option>
                          <option value="zte" {% if request.args.get('vendor') == 'zte' %}selected{% endif %}>ZTE</option>
                          <option value="vsol" {% if request.args.get('vendor') == 'vsol' %}selected{% endif %}>V-SOL</option>
                          <option value="juniper" {% if request.args.get('vendor') == 'juniper' %}selected{% endif %}>Juniper</option>
                          <option value="cisco" {% if request.args.get('vendor') == 'cisco' %}selected{% endif %}>Cisco</option>
                      </select>
                  </div>
                  <div class="flex items-end">
                      <button type="submit" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                          Filtrar
                      </button>
                  </div>
              </form>
          </div>

          <!-- Data Table -->
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
              <div class="overflow-x-auto">
                  <table class="w-full text-left text-sm">
                      <thead class="bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700">
                          <tr>
                              <th class="px-6 py-4 font-medium text-gray-500 dark:text-gray-400">ID</th>
                              <th class="px-6 py-4 font-medium text-gray-500 dark:text-gray-400">Nome</th>
                              <th class="px-6 py-4 font-medium text-gray-500 dark:text-gray-400">Tipo</th>
                              <th class="px-6 py-4 font-medium text-gray-500 dark:text-gray-400">Fabricante</th>
                              <th class="px-6 py-4 font-medium text-gray-500 dark:text-gray-400">Endereço IP</th>
                              <th class="px-6 py-4 font-medium text-gray-500 dark:text-gray-400">Status</th>
                              <th class="px-6 py-4 font-medium text-gray-500 dark:text-gray-400 text-right">Ações</th>
                          </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                          {% for item in items %}
                          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                              <td class="px-6 py-4 text-gray-600 dark:text-gray-400">#{{ item.id }}</td>
                              <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">{{ item.name | replace("'", "") }}</td>
                              <td class="px-6 py-4 text-gray-600 dark:text-gray-400">{{ item.type }}</td>
                              <td class="px-6 py-4 text-gray-600 dark:text-gray-400">{{ item.vendor }}</td>
                              <td class="px-6 py-4 text-gray-600 dark:text-gray-400">{{ item.host }}:{{ item.port }}</td>
                              <td class="px-6 py-4">
                                  <span class="px-2 py-1 text-xs font-medium rounded-full 
                                      {% if item.enabled %}bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400
                                      {% else %}bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400{% endif %}">
                                      {{ 'Ativo' if item.enabled else 'Inativo' }}
                                  </span>
                              </td>
                              <td class="px-6 py-4 text-right space-x-2">
                                  <button onclick="testConnection({{ item.id }})" 
                                      class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300" title="Testar Conexão">
                                      <i class="fas fa-network-wired"></i>
                                  </button>
                                  <button onclick='editDevice({{ item.id }}, {{ item.name | tojson }}, {{ item.type | tojson }}, {{ item.vendor | tojson }}, {{ item.host | tojson }}, {{ item.port }}, {{ item.username | tojson }}, {{ item.password | tojson }}, {{ "true" if item.enabled else "false" }})' 
                                      class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                                      <i class="fas fa-edit"></i>
                                  </button>
                                  <button onclick="deleteDevice({{ item.id }})" 
                                      class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                                      <i class="fas fa-trash"></i>
                                  </button>
                              </td>
                          </tr>
                          {% else %}
                          <tr>
                              <td colspan="7" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                                  Nenhum dispositivo encontrado
                              </td>
                          </tr>
                          {% endfor %}
                      </tbody>
                  </table>
              </div>
          </div>
      </div>

      <!-- Device Modal -->
      <div id="deviceModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
          <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
              <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="ISP_ERP.closeModal('deviceModal')"></div>
              <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
              <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                  <form method="POST" action="{{ url_for('admin_network_devices') }}">
                      <input type="hidden" name="id" id="deviceId">
                      <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                          <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4" id="modalTitle">
                              Novo Dispositivo
                          </h3>
                          <div class="grid grid-cols-1 gap-4">
                              <div>
                                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome</label>
                                  <input type="text" name="name" id="deviceName" required class="mt-1 w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                              </div>
                              <div class="grid grid-cols-2 gap-4">
                                  <div>
                                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo</label>
                                      <select name="type" id="deviceType" class="mt-1 w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                          <option value="router">Roteador</option>
                                          <option value="olt">OLT</option>
                                          <option value="switch">Switch</option>
                                      </select>
                                  </div>
                                  <div>
                                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Fabricante</label>
                                      <select name="vendor" id="deviceVendor" class="mt-1 w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                          <option value="mikrotik">Mikrotik</option>
                                          <option value="huawei">Huawei</option>
                                          <option value="zte">ZTE</option>
                                          <option value="vsol">V-SOL</option>
                                          <option value="generic">Genérico</option>
                                      </select>
                                  </div>
                              </div>
                              <div class="grid grid-cols-2 gap-4">
                                  <div>
                                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">IP / Host</label>
                                      <input type="text" name="host" id="deviceHost" required class="mt-1 w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                  </div>
                                  <div>
                                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Porta API</label>
                                      <input type="number" name="port" id="devicePort" value="8728" class="mt-1 w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                  </div>
                              </div>
                              <div class="grid grid-cols-2 gap-4">
                                  <div>
                                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Usuário</label>
                                      <input type="text" name="username" id="deviceUsername" class="mt-1 w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                  </div>
                                  <div>
                                      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Senha</label>
                                      <input type="password" name="password" id="devicePassword" class="mt-1 w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                  </div>
                              </div>
                              <div class="flex items-center">
                                  <input type="checkbox" name="enabled" id="deviceEnabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                  <label for="deviceEnabled" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                                      Dispositivo Ativo
                                  </label>
                              </div>
                          </div>
                      </div>
                      <div class="bg-gray-50 dark:bg-gray-700/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                          <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                              Salvar
                          </button>
                          <button type="button" onclick="ISP_ERP.closeModal('deviceModal')" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                              Cancelar
                          </button>
                      </div>
                  </form>
              </div>
          </div>
      </div>

    </div>
  </main>

  {% include 'components/footer.html' %}
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script src="{{ url_for('static', filename='js/navbar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/footer.js') }}"></script>
  <script src="{{ url_for('static', filename='js/components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/advanced-components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

  <script>
    function openDeviceModal() {
        document.getElementById('deviceId').value = '';
        document.getElementById('modalTitle').textContent = 'Novo Dispositivo';
        document.getElementById('deviceName').value = '';
        document.getElementById('deviceType').value = 'router';
        document.getElementById('deviceVendor').value = 'mikrotik';
        document.getElementById('deviceHost').value = '';
        document.getElementById('devicePort').value = '8728';
        document.getElementById('deviceUsername').value = '';
        document.getElementById('devicePassword').value = '';
        document.getElementById('deviceEnabled').checked = true;
        
        ISP_ERP.openModal('deviceModal');
    }

    function editDevice(id, name, type, vendor, host, port, username, password, enabled) {
        document.getElementById('deviceId').value = id;
        document.getElementById('modalTitle').textContent = 'Editar Dispositivo';
        document.getElementById('deviceName').value = name;
        document.getElementById('deviceType').value = type;
        document.getElementById('deviceVendor').value = vendor;
        document.getElementById('deviceHost').value = host;
        document.getElementById('devicePort').value = port;
        document.getElementById('deviceUsername').value = username;
        // Password field left empty for security, only update if entered
        document.getElementById('devicePassword').value = ''; 
        document.getElementById('deviceEnabled').checked = enabled;
        
        ISP_ERP.openModal('deviceModal');
    }

    async function deleteDevice(id) {
        if (!confirm('Tem certeza que deseja excluir este dispositivo?')) return;
        
        try {
            const response = await fetch(`/admin/network/devices/${id}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Erro ao excluir dispositivo');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Erro ao excluir dispositivo');
        }
    }

    async function testConnection(id) {
        try {
            const btn = event.currentTarget;
            const icon = btn.querySelector('i');
            const originalClass = icon.className;
            
            icon.className = 'fas fa-spinner fa-spin';
            
            const response = await fetch(`/admin/network/devices/${id}/test`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Conexão realizada com sucesso!');
            } else {
                alert('Erro na conexão: ' + data.message);
            }
            
            icon.className = originalClass;
        } catch (error) {
            console.error('Error:', error);
            alert('Erro ao testar conexão');
        }
    }
  </script>
</body>
</html>