<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Promessas de Pagamento - ISP ERP</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}" />
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-components.css') }}" />
</head>
<body>
  <a href="#main-content" class="skip-link">Pular para o conte√∫do principal</a>
  {% include 'components/navbar.html' %}

  <main id="main-content" class="main-content">
    <div class="container">
      <nav aria-label="Breadcrumb" class="breadcrumb">
        <span class="breadcrumb-item"><a href="/">Home</a></span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item"><a href="/admin/finance">Financeiro</a></span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">Promessas de Pagamento</span>
      </nav>

      <header class="page-header">
        <div class="page-header-content">
          <h1 class="page-title">Promessas de Pagamento</h1>
          <p class="page-subtitle">Gerencie as promessas de pagamento dos clientes</p>
        </div>
        <div class="page-header-actions">
          <button type="button" class="btn btn-primary" data-modal-target="modal-promise">
            <span aria-hidden="true">‚ûï</span>
            Nova Promessa
          </button>
        </div>
      </header>
      
      <div id="filter-container"></div>

      <div class="card">
        <div class="card-body">
          <div id="table-container"></div>
        </div>
      </div>
      <div id="pagination-container"></div>
    </div>
  </main>

  <div id="modal-promise" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Nova Promessa</h2>
        <button class="modal-close" aria-label="Fechar modal">‚úï</button>
      </div>
      <div class="modal-body">
        <form id="form-promise" method="post" action="{{ url_for('admin_payment_promises') }}" data-validate>
          <input type="hidden" name="id" id="promise-id" />
          
          <div class="form-group">
            <label for="client_id" class="form-label required">ID do Cliente</label>
            <input type="number" id="client_id" name="client_id" class="form-control" required />
          </div>
          
          <div class="form-group">
            <label for="contract_id" class="form-label required">ID do Contrato</label>
            <input type="number" id="contract_id" name="contract_id" class="form-control" required />
          </div>
          
          <div class="form-group">
            <label for="title_id" class="form-label">ID do T√≠tulo (Opcional)</label>
            <input type="number" id="title_id" name="title_id" class="form-control" />
          </div>

          <div class="form-group">
            <label for="promised_date" class="form-label required">Data da Promessa</label>
            <input type="date" id="promised_date" name="promised_date" class="form-control" required />
          </div>

          <div class="form-group">
            <label for="amount" class="form-label required">Valor (R$)</label>
            <input type="number" id="amount" name="amount" class="form-control" step="0.01" required />
          </div>

          <div class="form-group">
            <label for="status" class="form-label required">Status</label>
            <select id="status" name="status" class="form-select" required>
              <option value="open">Aberta</option>
              <option value="kept">Cumprida</option>
              <option value="broken">Quebrada</option>
            </select>
          </div>

          <div class="form-group">
            <label for="notes" class="form-label">Observa√ß√µes</label>
            <textarea id="notes" name="notes" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-modal-close>Cancelar</button>
        <button type="submit" form="form-promise" class="btn btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  {% include 'components/footer.html' %}
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script src="{{ url_for('static', filename='js/navbar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/footer.js') }}"></script>
  <script src="{{ url_for('static', filename='js/components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/advanced-components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

  <script>
    const promisesData = [
      {% for item in items %}
      {
        id: {{ item.id }},
        client_id: {{ item.client_id }},
        contract_id: {{ item.contract_id }},
        title_id: {{ item.title_id if item.title_id else 'null' }},
        promised_date: '{{ item.promised_date }}',
        amount: {{ item.amount }},
        status: '{{ item.status }}',
        notes: '{{ (item.notes or "") | replace("'", "\\'") }}',
        created_at: '{{ item.created_at.isoformat() }}'
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ];

    document.addEventListener('DOMContentLoaded', function() {
      
      const filterPanel = new ISP_Components.FilterPanel({
        container: '#filter-container',
        filters: [
          { type: 'text', name: 'client_id', label: 'ID Cliente', placeholder: 'ID Cliente' },
          { type: 'select', name: 'status', label: 'Status', options: [
              { value: '', label: 'Todos' },
              { value: 'open', label: 'Aberta' },
              { value: 'kept', label: 'Cumprida' },
              { value: 'broken', label: 'Quebrada' }
            ] 
          }
        ],
        onApply: (filters) => {
          const params = new URLSearchParams(window.location.search);
          Object.keys(filters).forEach(key => {
             if(filters[key]) params.set(key, filters[key]);
             else params.delete(key);
          });
          window.location.search = params.toString();
        },
        onReset: () => {
          window.location.href = window.location.pathname;
        }
      });

      const dataTable = new ISP_Components.DataTable({
        container: '#table-container',
        columns: [
          { field: 'id', label: 'ID', sortable: true },
          { field: 'client_id', label: 'Cliente', sortable: true },
          { field: 'promised_date', label: 'Data Promessa', sortable: true, render: (val) => new Date(val).toLocaleDateString('pt-BR') },
          { field: 'amount', label: 'Valor', sortable: true, type: 'currency' },
          { 
            field: 'status', 
            label: 'Status', 
            sortable: true,
            render: (val) => {
              const map = { 'open': 'Aberta', 'kept': 'Cumprida', 'broken': 'Quebrada' };
              const cls = { 'open': 'primary', 'kept': 'success', 'broken': 'danger' };
              return `<span class="status-indicator ${cls[val] || 'secondary'}"><span class="status-dot"></span>${map[val] || val}</span>`;
            }
          }
        ],
        data: promisesData,
        actions: [
          { name: 'edit', label: 'Editar', icon: '‚úèÔ∏è', handler: (row) => editPromise(row) },
          { name: 'delete', label: 'Excluir', icon: 'üóëÔ∏è', variant: 'danger', handler: (row) => deletePromise(row) }
        ],
        emptyMessage: 'Nenhuma promessa de pagamento encontrada'
      });
      
      new ISP_Components.Pagination({
        container: '#pagination-container',
        total: promisesData.length,
        currentPage: 1,
        pageSize: 10
      });
      
      const formValidator = new ISP_Components.FormValidator('#form-promise', {});
      
      window.editPromise = (row) => {
        document.getElementById('promise-id').value = row.id;
        document.getElementById('client_id').value = row.client_id;
        document.getElementById('contract_id').value = row.contract_id;
        document.getElementById('title_id').value = row.title_id || '';
        document.getElementById('promised_date').value = row.promised_date;
        document.getElementById('amount').value = row.amount;
        document.getElementById('status').value = row.status;
        document.getElementById('notes').value = row.notes;
        
        document.getElementById('modal-title').textContent = 'Editar Promessa';
        ISP_ERP.openModal('modal-promise');
      };

      document.querySelectorAll('[data-modal-target="modal-promise"]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById('form-promise').reset();
          document.getElementById('promise-id').value = '';
          document.getElementById('modal-title').textContent = 'Nova Promessa';
          ISP_ERP.openModal('modal-promise');
        });
      });

      document.querySelectorAll('[data-modal-close]').forEach(btn => {
        btn.addEventListener('click', () => {
          ISP_ERP.closeModal('modal-promise');
        });
      });

      window.deletePromise = (row) => {
        ISP_ERP.confirm('Tem certeza que deseja excluir esta promessa?', (confirmed) => {
          if (confirmed) {
            fetch(`/admin/finance/promises/${row.id}/delete`, { method: 'POST' })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  ISP_AdvancedComponents.Toast.success('Promessa exclu√≠da com sucesso!');
                  setTimeout(() => window.location.reload(), 1000);
                } else {
                  ISP_AdvancedComponents.Toast.error(data.error || 'Erro ao excluir promessa');
                }
              })
              .catch(err => {
                ISP_AdvancedComponents.Toast.error('Erro de conex√£o');
              });
          }
        });
      };
    });
  </script>
</body>
</html>