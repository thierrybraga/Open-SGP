<!--
Arquivo: admin_panel/templates/admin_network_profiles.html

Responsabilidade:
Listar e gerenciar perfis de velocidade e QoS.

IntegraÃ§Ãµes:
- admin_panel/app.py
-->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perfis de Rede - ISP ERP</title>

  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}" />
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-components.css') }}" />
</head>
<body>
  <!-- Skip Link -->
  <a href="#main-content" class="skip-link">Pular para o conteÃºdo principal</a>

  <!-- Navigation -->
  {% include 'components/navbar.html' %}

  <!-- Main Content -->
  <main id="main-content" class="main-content">
    <div class="container">

      <!-- Breadcrumbs -->
      <nav aria-label="Breadcrumb" class="breadcrumb">
        <span class="breadcrumb-item">
          <a href="/">Home</a>
        </span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">
          <a href="/admin/network">Rede</a>
        </span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">Perfis de Rede</span>
      </nav>

      <!-- Page Header -->
      <header class="page-header">
        <div class="page-header-content">
          <h1 class="page-title">Perfis de Rede</h1>
          <p class="page-subtitle">Gerencie os perfis de velocidade e QoS</p>
        </div>
        <div class="page-header-actions">
          <button type="button" class="btn btn-outline-primary" onclick="refreshData()">
            <span aria-hidden="true">ðŸ”„</span>
            Atualizar
          </button>
          <button type="button" class="btn btn-primary" data-modal-target="modal-profile">
            <span aria-hidden="true">âž•</span>
            Novo Perfil
          </button>
        </div>
      </header>

      <!-- Filters -->
      <div id="filter-container"></div>

      <!-- Data Table -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Perfis Cadastrados</h2>
        </div>
        <div class="card-body">
          <div id="table-container"></div>
        </div>
      </div>

      <!-- Pagination -->
      <div id="pagination-container"></div>

    </div>
  </main>

  <!-- Modal: New/Edit Profile -->
  <div id="modal-profile" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Novo Perfil</h2>
        <button class="modal-close" aria-label="Fechar modal">âœ•</button>
      </div>
      <div class="modal-body">
        <form id="form-profile" method="post" data-validate>
          <input type="hidden" name="id" id="profile-id" />
          
          <div class="form-group">
            <label for="name" class="form-label required">Nome</label>
            <input type="text" id="name" name="name" class="form-control" required placeholder="Ex: 100 Mega" />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="download_speed_mbps" class="form-label required">Download (Mbps)</label>
              <input type="number" id="download_speed_mbps" name="download_speed_mbps" class="form-control" step="0.1" required />
            </div>
            <div class="form-group">
              <label for="upload_speed_mbps" class="form-label required">Upload (Mbps)</label>
              <input type="number" id="upload_speed_mbps" name="upload_speed_mbps" class="form-control" step="0.1" required />
            </div>
          </div>

          <div class="form-group">
            <label class="form-checkbox">
              <input type="checkbox" id="burst_enabled" name="burst_enabled" />
              <span>Habilitar Burst</span>
            </label>
          </div>

          <div class="form-row" id="burst-fields" style="display: none;">
            <div class="form-group">
              <label for="burst_rate_percent" class="form-label">Burst Rate (%)</label>
              <input type="number" id="burst_rate_percent" name="burst_rate_percent" class="form-control" step="1" value="0" />
            </div>
            <div class="form-group">
              <label for="burst_threshold_seconds" class="form-label">Burst Threshold (Segundos)</label>
              <input type="number" id="burst_threshold_seconds" name="burst_threshold_seconds" class="form-control" step="1" value="0" />
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-modal-close>Cancelar</button>
        <button type="submit" form="form-profile" class="btn btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  {% include 'components/footer.html' %}

  <!-- JavaScript -->
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script src="{{ url_for('static', filename='js/navbar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/footer.js') }}"></script>
  <script src="{{ url_for('static', filename='js/components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/advanced-components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {

      // Filter Panel
      const filterPanel = new ISP_Components.FilterPanel({
        container: '#filter-container',
        filters: [
          { type: 'text', name: 'name', label: 'Nome', placeholder: 'Filtrar por nome' }
        ],
        onApply: (filters) => {
          const params = new URLSearchParams(window.location.search);
          Object.keys(filters).forEach(key => {
             if(filters[key]) params.set(key, filters[key]);
             else params.delete(key);
          });
          window.location.search = params.toString();
        },
        onReset: () => {
          window.location.href = window.location.pathname;
        }
      });

      // Data
      const profilesData = [
        {% for item in items %}
        {
          id: {{ item.id }},
          name: '{{ item.name | replace("'", "\\'") }}',
          download_speed_mbps: {{ item.download_speed_mbps }},
          upload_speed_mbps: {{ item.upload_speed_mbps }},
          burst_enabled: {{ 'true' if item.burst_enabled else 'false' }},
          burst_rate_percent: {{ item.burst_rate_percent }},
          burst_threshold_seconds: {{ item.burst_threshold_seconds }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ];

      // Data Table
      const dataTable = new ISP_Components.DataTable({
        container: '#table-container',
        columns: [
          { field: 'id', label: 'ID', sortable: true },
          { field: 'name', label: 'Nome', sortable: true },
          { field: 'download_speed_mbps', label: 'Down (Mbps)', sortable: true },
          { field: 'upload_speed_mbps', label: 'Up (Mbps)', sortable: true },
          { 
            field: 'burst_enabled', 
            label: 'Burst', 
            render: (val) => val ? '<span class="status-indicator success">Sim</span>' : '<span class="status-indicator secondary">NÃ£o</span>' 
          }
        ],
        data: profilesData,
        actions: [
          { name: 'edit', label: 'Editar', icon: 'âœï¸', handler: (row) => editProfile(row) },
          { name: 'delete', label: 'Excluir', icon: 'ðŸ—‘ï¸', variant: 'danger', handler: (row) => deleteProfile(row) }
        ],
        emptyMessage: 'Nenhum perfil encontrado'
      });

      // Pagination
      new ISP_Components.Pagination({
        container: '#pagination-container',
        total: profilesData.length,
        currentPage: 1, // Simple pagination for now
        pageSize: 100
      });

      // Form Validator
      const formValidator = new ISP_Components.FormValidator('#form-profile', {
        name: { required: true },
        download_speed_mbps: { required: true, number: true },
        upload_speed_mbps: { required: true, number: true }
      });

      // Burst fields toggle
      const burstCheckbox = document.getElementById('burst_enabled');
      const burstFields = document.getElementById('burst-fields');
      
      function toggleBurstFields() {
        burstFields.style.display = burstCheckbox.checked ? 'grid' : 'none';
      }
      
      burstCheckbox.addEventListener('change', toggleBurstFields);

      // Form Submission
      document.getElementById('form-profile').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!formValidator.validate()) return;

        const formData = new FormData(this);
        
        fetch(window.location.pathname, {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.ok) {
            ISP_ERP.closeModal('modal-profile');
            ISP_AdvancedComponents.Toast.success('Perfil salvo com sucesso!');
            setTimeout(() => window.location.reload(), 1500);
          } else {
            throw new Error('Erro ao salvar perfil');
          }
        })
        .catch(error => {
          ISP_AdvancedComponents.Toast.error('Erro ao salvar perfil');
          console.error(error);
        });
      });

      // Edit Profile
      window.editProfile = function(row) {
        document.getElementById('profile-id').value = row.id;
        document.getElementById('name').value = row.name;
        document.getElementById('download_speed_mbps').value = row.download_speed_mbps;
        document.getElementById('upload_speed_mbps').value = row.upload_speed_mbps;
        
        const burstCb = document.getElementById('burst_enabled');
        burstCb.checked = row.burst_enabled;
        
        document.getElementById('burst_rate_percent').value = row.burst_rate_percent;
        document.getElementById('burst_threshold_seconds').value = row.burst_threshold_seconds;
        
        toggleBurstFields();
        
        document.getElementById('modal-title').textContent = 'Editar Perfil';
        ISP_ERP.openModal('modal-profile');
      };

      // Delete Profile
      window.deleteProfile = function(row) {
        ISP_ERP.confirm(
          `Tem certeza que deseja excluir o perfil "${row.name}"?`,
          function(confirmed) {
            if (confirmed) {
              fetch(`/admin/network/profiles/${row.id}/delete`, {
                method: 'POST'
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  ISP_AdvancedComponents.Toast.success('Perfil excluÃ­do com sucesso!');
                  setTimeout(() => window.location.reload(), 1500);
                } else {
                  ISP_AdvancedComponents.Toast.error(data.error || 'Erro ao excluir perfil');
                }
              })
              .catch(error => {
                ISP_AdvancedComponents.Toast.error('Erro ao excluir perfil');
                console.error(error);
              });
            }
          }
        );
      };

      // Refresh
      window.refreshData = function() {
        ISP_AdvancedComponents.Toast.info('Atualizando dados...');
        setTimeout(() => window.location.reload(), 1000);
      };

      // Modal Reset
      document.querySelectorAll('[data-modal-close]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.getElementById('form-profile').reset();
          formValidator.reset();
          document.getElementById('profile-id').value = '';
          document.getElementById('modal-title').textContent = 'Novo Perfil';
          toggleBurstFields();
        });
      });
      
    });
  </script>

  <style>
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-md);
    }
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    .card-header {
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--border-color);
    }
    .card-title {
      margin: 0;
      font-size: var(--font-size-lg);
    }
  </style>
</body>
</html>
