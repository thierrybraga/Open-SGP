<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pontos de Recebimento - ISP ERP</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}" />
  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/advanced-components.css') }}" />
</head>
<body>
  <a href="#main-content" class="skip-link">Pular para o conteÃºdo principal</a>
  {% include 'components/navbar.html' %}

  <main id="main-content" class="main-content">
    <div class="container">
      <nav aria-label="Breadcrumb" class="breadcrumb">
        <span class="breadcrumb-item"><a href="/">Home</a></span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item"><a href="/admin/finance">Financeiro</a></span>
        <span class="breadcrumb-separator" aria-hidden="true">/</span>
        <span class="breadcrumb-item">Pontos de Recebimento</span>
      </nav>

      <header class="page-header">
        <div class="page-header-content">
          <h1 class="page-title">Pontos de Recebimento</h1>
          <p class="page-subtitle">Gerencie os pontos de recebimento de pagamentos</p>
        </div>
        <div class="page-header-actions">
          <button type="button" class="btn btn-primary" data-modal-target="modal-receipt">
            <span aria-hidden="true">âž•</span>
            Novo Ponto
          </button>
        </div>
      </header>

      <div id="filter-container"></div>

      <div class="card">
        <div class="card-body">
          <div id="table-container"></div>
        </div>
      </div>
      <div id="pagination-container"></div>
    </div>
  </main>

  <div id="modal-receipt" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Novo Ponto de Recebimento</h2>
        <button class="modal-close" aria-label="Fechar modal">âœ•</button>
      </div>
      <div class="modal-body">
        <form id="form-receipt" method="post" action="{{ url_for('admin_finance_receipts') }}" data-validate>
          <input type="hidden" name="id" id="receipt-id" />
          <div class="form-group">
            <label for="name" class="form-label required">Nome</label>
            <input type="text" id="name" name="name" class="form-control" required placeholder="Ex: Caixa Central" />
          </div>
          <div class="form-group">
            <label for="description" class="form-label required">DescriÃ§Ã£o</label>
            <textarea id="description" name="description" class="form-control" required rows="3"></textarea>
          </div>
          <div class="form-group">
            <label for="company_id" class="form-label">Empresa</label>
            <select id="company_id" name="company_id" class="form-select">
              <option value="">Selecione...</option>
              {% for c in companies %}
              <option value="{{ c.id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-modal-close>Cancelar</button>
        <button type="submit" form="form-receipt" class="btn btn-primary">Salvar</button>
      </div>
    </div>
  </div>

  {% include 'components/footer.html' %}
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script src="{{ url_for('static', filename='js/navbar.js') }}"></script>
  <script src="{{ url_for('static', filename='js/footer.js') }}"></script>
  <script src="{{ url_for('static', filename='js/components.js') }}"></script>
  <script src="{{ url_for('static', filename='js/advanced-components.css') }}"></script>
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

  <script>
    const sampleData = {{ items|tojson|safe if items else '[]' }};
    document.addEventListener('DOMContentLoaded', function() {
      
      const filterPanel = new ISP_Components.FilterPanel({
        container: '#filter-container',
        filters: [
          { type: 'text', name: 'name', label: 'Nome', placeholder: 'Filtrar por nome' },
          { type: 'text', name: 'description', label: 'DescriÃ§Ã£o', placeholder: 'Filtrar por descriÃ§Ã£o' }
        ],
        onApply: (filters) => {
          const params = new URLSearchParams(window.location.search);
          Object.keys(filters).forEach(key => {
             if(filters[key]) params.set(key, filters[key]);
             else params.delete(key);
          });
          window.location.search = params.toString();
        },
        onReset: () => {
          window.location.href = window.location.pathname;
        }
      });

      const dataTable = new ISP_Components.DataTable({
        container: '#table-container',
        columns: [
          { field: 'id', label: 'ID', sortable: true },
          { field: 'name', label: 'Nome', sortable: true },
          { field: 'description', label: 'DescriÃ§Ã£o', sortable: true },
          { field: 'company', label: 'Empresa', sortable: true, render: (val) => val ? val.name : '-' }
        ],
        data: sampleData,
        actions: [
          { name: 'edit', label: 'Editar', icon: 'âœï¸', handler: function(row) { editReceipt(row); }},
          { name: 'delete', label: 'Excluir', icon: 'ðŸ—‘ï¸', variant: 'danger', handler: function(row) { deleteReceipt(row); }}
        ],
        emptyMessage: 'Nenhum ponto de recebimento cadastrado'
      });

      new ISP_Components.Pagination({ container: '#pagination-container', total: sampleData.length, currentPage: 1, pageSize: 10 });

      const formValidator = new ISP_Components.FormValidator('#form-receipt', {
        name: { required: true, minLength: 3, messages: { required: 'Nome Ã© obrigatÃ³rio', minLength: 'MÃ­nimo 3 caracteres' }},
        description: { required: true, messages: { required: 'DescriÃ§Ã£o Ã© obrigatÃ³ria' }}
      });

      document.getElementById('form-receipt').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!formValidator.validate()) return;
        fetch(this.action, { method: 'POST', body: new FormData(this) })
          .then(r => r.json())
          .then(d => { ISP_ERP.closeModal('modal-receipt'); ISP_AdvancedComponents.Toast.success('Ponto salvo!'); location.reload(); })
          .catch(e => ISP_AdvancedComponents.Toast.error('Erro ao salvar'));
      });

      window.editReceipt = function(row) {
        document.getElementById('receipt-id').value = row.id;
        document.getElementById('name').value = row.name;
        document.getElementById('description').value = row.description;
        document.getElementById('company_id').value = row.company ? row.company.id : '';
        document.getElementById('modal-title').textContent = 'Editar Ponto';
        ISP_ERP.openModal('modal-receipt');
      };

      window.deleteReceipt = function(row) {
        ISP_ERP.confirm(`Excluir "${row.name}"?`, c => { 
            if(c) { 
                fetch(`/admin/finance/receipts/${row.id}/delete`, { method: 'POST' })
                .then(r => r.json())
                .then(d => {
                    ISP_AdvancedComponents.Toast.success('ExcluÃ­do!'); 
                    location.reload(); 
                });
            }
        });
      };

      document.querySelectorAll('[data-modal-close]').forEach(btn => {
        btn.addEventListener('click', () => { 
            document.getElementById('form-receipt').reset(); 
            document.getElementById('receipt-id').value = '';
            document.getElementById('modal-title').textContent = 'Novo Ponto de Recebimento';
            formValidator.reset(); 
        });
      });
    });
  </script>
</body>
</html>
