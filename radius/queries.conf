#  Configuration for the SQL module
#
#  The query to find the client.
#
#  We map SGP 'nas' table columns to FreeRADIUS expected columns:
#  ip_address -> nasname
#  name -> shortname
#  secret -> secret
#  vendor -> type (optional, defaulting to 'other')
#
client_query = "SELECT id, ip_address AS nasname, name AS shortname, 'other' AS type, secret, NULL AS server, NULL AS community, name AS description FROM nas"

#
#  Use the default queries for everything else
#  (These are usually standard and match our RadCheck/RadReply models)
#
authorize_check_query = "SELECT id, username, attribute, value, op FROM ${authcheck_table} WHERE username = '%{SQL-User-Name}' ORDER BY id"
authorize_reply_query = "SELECT id, username, attribute, value, op FROM ${authreply_table} WHERE username = '%{SQL-User-Name}' ORDER BY id"

group_membership_query = "SELECT groupname FROM ${usergroup_table} WHERE username = '%{SQL-User-Name}' ORDER BY priority"
group_check_query = "SELECT id, groupname, attribute, value, op FROM ${groupcheck_table} WHERE groupname = '%{Sql-Group}' ORDER BY id"
group_reply_query = "SELECT id, groupname, attribute, value, op FROM ${groupreply_table} WHERE groupname = '%{Sql-Group}' ORDER BY id"

# Accounting queries
accounting_on = "UPDATE ${acct_table1} SET acctstoptime = to_timestamp(%{integer:Event-Timestamp}), acctsessiontime = unix_timestamp(to_timestamp(%{integer:Event-Timestamp})) - unix_timestamp(acctstarttime), acctterminatecause = '%{Acct-Terminate-Cause}' WHERE acctstoptime IS NULL AND nasipaddress = '%{NAS-IP-Address}' AND acctstarttime <= to_timestamp(%{integer:Event-Timestamp})"
accounting_off = "UPDATE ${acct_table1} SET acctstoptime = to_timestamp(%{integer:Event-Timestamp}), acctsessiontime = unix_timestamp(to_timestamp(%{integer:Event-Timestamp})) - unix_timestamp(acctstarttime), acctterminatecause = '%{Acct-Terminate-Cause}' WHERE acctstoptime IS NULL AND nasipaddress = '%{NAS-IP-Address}' AND acctstarttime <= to_timestamp(%{integer:Event-Timestamp})"

accounting_start_query = "INSERT INTO ${acct_table1} (acctsessionid, acctuniqueid, username, realm, nasipaddress, nasportid, nasporttype, acctstarttime, acctauthentic, connectinfo_start, calledstationid, callingstationid, servicetype, framedprotocol, framedipaddress) VALUES ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', '%{SQL-User-Name}', '%{Realm}', '%{NAS-IP-Address}', '%{NAS-Port}', '%{NAS-Port-Type}', to_timestamp(%{integer:Event-Timestamp}), '%{Acct-Authentic}', '%{Connect-Info}', '%{Called-Station-Id}', '%{Calling-Station-Id}', '%{Service-Type}', '%{Framed-Protocol}', '%{Framed-IP-Address}')"

accounting_update_query = "UPDATE ${acct_table1} SET acctupdatetime = to_timestamp(%{integer:Event-Timestamp}), acctinterval = %{integer:Acct-Delay-Time}, acctsessiontime = %{integer:Acct-Session-Time}, acctinputoctets = %{integer:Acct-Input-Octets}, acctoutputoctets = %{integer:Acct-Output-Octets} WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"

accounting_stop_query = "UPDATE ${acct_table1} SET acctstoptime = to_timestamp(%{integer:Event-Timestamp}), acctsessiontime = %{integer:Acct-Session-Time}, acctinputoctets = %{integer:Acct-Input-Octets}, acctoutputoctets = %{integer:Acct-Output-Octets}, acctterminatecause = '%{Acct-Terminate-Cause}', connectinfo_stop = '%{Connect-Info}' WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"

simul_count_query = "SELECT COUNT(*) FROM ${acct_table1} WHERE username = '%{SQL-User-Name}' AND acctstoptime IS NULL"
